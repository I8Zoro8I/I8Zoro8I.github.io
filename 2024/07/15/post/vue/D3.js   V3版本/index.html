<!-- build time:Mon Aug 26 2024 23:30:30 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN,en,default"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="CYX" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="CYX" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="CYX" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="D3.js"><link rel="canonical" href="http://example.com/2024/07/15/post/vue/D3.js%20%20%20V3%E7%89%88%E6%9C%AC/"><title>D3.js V3版本 学习笔记 - 前端 | ZoroJan-个人博客 = CYX = Blog</title><meta name="generator" content="Hexo 7.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">D3.js V3版本 学习笔记</h1><div class="meta"><span class="item" title="创建时间：2024-07-15 11:24:48"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2024-07-15T11:24:48+08:00">2024-07-15</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>44k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>40 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">ZoroJan-个人博客</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="/assets/9.png"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/vue/" itemprop="item" rel="index" title="分类于 前端"><span itemprop="name">前端</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2024/07/15/post/vue/D3.js%20%20%20V3%E7%89%88%E6%9C%AC/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="ZoroJan"><meta itemprop="description" content="Blog, 我的个人博客"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="CYX"></span><div class="body md" itemprop="articleBody"><h1 id="d3.js-v3版本">D3.js V3版本</h1><h2 id="d3-tree">D3 Tree</h2><p>vue2 + d3 (3.5.17)</p><h4 id="安装组件">安装组件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install d3@3.5.17 -s   </span><br></pre></td></tr></table></figure><p><span class="citation" data-cites="后面是版本号">@后面是版本号</span>，不加默认下载最新版</p><p>页面（组件）引用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> d3 <span class="keyword">from</span> <span class="string">&quot;d3&quot;</span>;</span><br></pre></td></tr></table></figure><h3 id="直接上一个简单案例">直接上一个简单案例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;screenshot&quot; style=&quot;width:100%;height:90%&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div id=&quot;tree-container&quot; style=&quot;width:100%;height:95%;&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;div ref=&quot;container&quot;&gt;&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import * as d3 from &#x27;d3&#x27;;</span><br><span class="line">import $ from &#x27;jquery&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">  data()&#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      treeData:&#123;</span><br><span class="line">        name: &#x27;收入&#x27;,</span><br><span class="line">        value:100,</span><br><span class="line">        children: [</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;电费收入&#x27;,</span><br><span class="line">            value: 10,</span><br><span class="line">            children: []</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;供热收入&#x27;,</span><br><span class="line">            value: 8,</span><br><span class="line">            children: []</span><br><span class="line">          &#125;</span><br><span class="line">          ,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;副产品收入&#x27;,</span><br><span class="line">            value: 8,</span><br><span class="line">            children: []</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;其他收入&#x27;,</span><br><span class="line">            value: 8,</span><br><span class="line">            children: []</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    this.drawTree();</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    drawTree() &#123;</span><br><span class="line">    // 设置图表的宽高和Margin</span><br><span class="line">      var margin = &#123; top: 20, right: 90, bottom: 30, left: 90 &#125;,</span><br><span class="line">          width = 960 - margin.left - margin.right,</span><br><span class="line">          height = 500 - margin.top - margin.bottom;</span><br><span class="line"></span><br><span class="line">      //创建视图</span><br><span class="line">      let svg = d3.select(this.$refs.container)</span><br><span class="line">          .append(&#x27;svg&#x27;)</span><br><span class="line">          .attr(&#x27;width&#x27;, width + margin.right + margin.left)</span><br><span class="line">          .attr(&#x27;height&#x27;, height + margin.top + margin.bottom)</span><br><span class="line">          .append(&#x27;g&#x27;)</span><br><span class="line">          .call(this.zoomListener)</span><br><span class="line">          .attr(&quot;transform&quot;, &quot;translate(&quot; + margin.left + &quot;,&quot; + margin.top + &quot;)&quot;)</span><br><span class="line"></span><br><span class="line">      //定义节点拖放行为的拖动侦听器。</span><br><span class="line"></span><br><span class="line">      //建立树布局</span><br><span class="line">      const treeLayout = d3.layout.tree()</span><br><span class="line">          .size([width, height]);</span><br><span class="line"></span><br><span class="line">      const nodes = treeLayout.nodes(this.treeData);</span><br><span class="line">      const links = treeLayout.links(nodes);</span><br><span class="line"></span><br><span class="line">      const nodeGroup = svg.selectAll(&#x27;.node&#x27;)</span><br><span class="line">          .data(nodes)</span><br><span class="line">          .enter()</span><br><span class="line">          .append(&#x27;g&#x27;)</span><br><span class="line">          .attr(&#x27;class&#x27;, &#x27;node&#x27;)</span><br><span class="line">          .attr(&#x27;transform&#x27;, d =&gt; `translate($&#123;d.x&#125;,$&#123;d.y&#125;)`);</span><br><span class="line"></span><br><span class="line">      nodeGroup.append(&#x27;rect&#x27;)//设置为矩形</span><br><span class="line">          .attr(&#x27;width&#x27;, 80) // 设置矩形宽度</span><br><span class="line">          .attr(&#x27;height&#x27;, 30) // 设置矩形高度</span><br><span class="line">          .attr(&#x27;x&#x27;, -40) // 调整矩形位置，使其居中</span><br><span class="line">          .attr(&#x27;y&#x27;, -15)</span><br><span class="line">          .attr(&#x27;rx&#x27;, 5) // 可选，设置矩形圆角</span><br><span class="line">          .attr(&#x27;ry&#x27;, 5)</span><br><span class="line">          .style(&#x27;fill&#x27;, &#x27;transparent&#x27;)</span><br><span class="line">          .style(&#x27;stroke&#x27;, &#x27;#000&#x27;) // 设置矩形边框颜色</span><br><span class="line">          .style(&#x27;stroke-width&#x27;, &#x27;1px&#x27;); // 设置矩形边框宽度; // 透明</span><br><span class="line">      nodeGroup.append(&#x27;line&#x27;) // 添加分割线</span><br><span class="line">          .attr(&#x27;x1&#x27;, -40) // 分割线的起始点 x 坐标</span><br><span class="line">          .attr(&#x27;y1&#x27;, 0) // 分割线的起始点 y 坐标</span><br><span class="line">          .attr(&#x27;x2&#x27;, 40) // 分割线的结束点 x 坐标</span><br><span class="line">          .attr(&#x27;y2&#x27;, 0) // 分割线的结束点 y 坐标</span><br><span class="line">          .style(&#x27;stroke&#x27;, &#x27;#000&#x27;) // 设置分割线颜色</span><br><span class="line">          .style(&#x27;stroke-width&#x27;, &#x27;1px&#x27;); // 设置分割线宽度</span><br><span class="line"></span><br><span class="line">      nodeGroup.append(&#x27;text&#x27;)</span><br><span class="line">          .attr(&#x27;dy&#x27;, -4) // 调整文本的垂直位置，使其居中</span><br><span class="line">          .style(&#x27;text-anchor&#x27;, &#x27;middle&#x27;) // 设置文本水平居中</span><br><span class="line">          .text(d =&gt; d.name);</span><br><span class="line"></span><br><span class="line">      nodeGroup.append(&#x27;text&#x27;)</span><br><span class="line">          .attr(&#x27;dy&#x27;, 13) // 调整文本的垂直位置，使其在矩形内部</span><br><span class="line">          .style(&#x27;text-anchor&#x27;, &#x27;middle&#x27;) // 设置文本水平居中</span><br><span class="line">          .text(d =&gt; d.value);</span><br><span class="line"></span><br><span class="line">      svg.selectAll(&#x27;.link&#x27;)</span><br><span class="line">          .data(links)</span><br><span class="line">          .enter()</span><br><span class="line">          .append(&#x27;path&#x27;)</span><br><span class="line">          .attr(&#x27;class&#x27;, &#x27;link&#x27;)</span><br><span class="line">          .attr(&#x27;d&#x27;, d =&gt; &#123;</span><br><span class="line">            return `M$&#123;d.source.x&#125;,$&#123;d.source.y+15&#125;L$&#123;d.target.x&#125;,$&#123;d.target.y-15&#125;`;</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">      const zoomHandler = d3.behavior.zoom()</span><br><span class="line">          .on(&#x27;zoom&#x27;, () =&gt; &#123;</span><br><span class="line">            svg.attr(&#x27;transform&#x27;, `translate($&#123;d3.event.translate&#125;)scale($&#123;d3.event.scale&#125;)`);</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">      svg.call(zoomHandler);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">circle &#123;</span><br><span class="line">  fill: #ccc;</span><br><span class="line">  stroke: #000;</span><br><span class="line">  stroke-width: 1px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">text &#123;</span><br><span class="line">  font-size: 12px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">path.link &#123;</span><br><span class="line">  fill: none;</span><br><span class="line">  stroke: #ccc;</span><br><span class="line">  stroke-width: 1.5px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p>我们可以看到D3.js的步骤其实就是</p><p><code>初始化图表 -&gt; 获取数据 -&gt; 数据转换 -&gt; 元素操作/交互/动画 -&gt; 事件绑定 -&gt; 数据更新 -&gt; 元素更新</code></p><h2 id="用d3-tree-做一个指标下钻功能">用D3 tree 做一个指标下钻功能</h2><p>看完上面哪个例子我们直接上难度，在大数据时代，很多数据客户都会要求直观的展示数据，这个指标下钻就是很普遍的客户需求，展示如下动图。</p><p>[双击收展、任意拖拉、滚轮缩放]</p><figure><img data-src="D:\Pictures\typore\006V2BDqly8hrp5pe8coxg30b408u41t.gif" alt="alt"><figcaption aria-hidden="true">alt</figcaption></figure><p>我们按照例子中的方法进行介绍：</p><p>图的绘制主要在drawTree 与 update中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">drawTree</span>(<span class="params"></span>) &#123;</span><br><span class="line">     <span class="comment">//show D3 tree</span></span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">depths</span> = <span class="variable language_">this</span>.<span class="title function_">treeDepths</span>(<span class="variable language_">this</span>.<span class="property">treeData</span>);</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">depths</span>)</span><br><span class="line">     <span class="comment">//建立树布局</span></span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">minHeight</span> = <span class="number">500</span>;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">viewerWidth</span> = $(<span class="string">&quot;#screenshot&quot;</span>).<span class="title function_">width</span>();</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">viewerHeight</span> = $(<span class="string">&quot;#screenshot&quot;</span>).<span class="title function_">height</span>();</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">viewerHeight</span>)</span><br><span class="line">     <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">viewerHeight</span> &lt; <span class="variable language_">this</span>.<span class="property">minHeight</span>)</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">viewerHeight</span> = <span class="variable language_">this</span>.<span class="property">minHeight</span></span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">viewerHeight</span>=<span class="number">500</span></span><br><span class="line"></span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">tree</span> = d3.<span class="property">layout</span>.<span class="title function_">tree</span>()</span><br><span class="line">         .<span class="title function_">size</span>([<span class="variable language_">this</span>.<span class="property">viewerHeight</span>, <span class="variable language_">this</span>.<span class="property">viewerWidth</span>]);</span><br><span class="line">     <span class="comment">//定义一个d3对角线投影，供稍后的节点路径使用</span></span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">diagonal</span> = d3.<span class="property">svg</span>.<span class="title function_">diagonal</span>()</span><br><span class="line">         .<span class="title function_">projection</span>(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> [d.<span class="property">y</span>, d.<span class="property">x</span>];</span><br><span class="line">         &#125;)</span><br><span class="line"></span><br><span class="line">     <span class="comment">//call visit to maxLabelLength</span></span><br><span class="line">     <span class="variable language_">this</span>.<span class="title function_">visit</span>(<span class="variable language_">this</span>.<span class="property">treeData</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">totalNodes</span>++;</span><br><span class="line">       <span class="keyword">if</span> (d.<span class="property">name</span>) &#123;</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">maxLabelLength</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(d.<span class="property">name</span>.<span class="property">length</span>, <span class="variable language_">this</span>.<span class="property">maxLabelLength</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="variable language_">this</span>.<span class="property">maxLabelLength</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">maxLabelLength</span>);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> d.<span class="property">children</span> &amp;&amp; d.<span class="property">children</span>.<span class="property">length</span> &gt; <span class="number">0</span> ? d.<span class="property">children</span> : <span class="literal">null</span>;</span><br><span class="line">     &#125;)</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;总节点&quot;</span>,<span class="variable language_">this</span>.<span class="property">totalNodes</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">//排序树最初是为了防止json没有按排序顺序排列</span></span><br><span class="line">     <span class="variable language_">this</span>.<span class="title function_">sortTree</span>()</span><br><span class="line">     <span class="comment">//定义 zoomListener，该 zoomListener 在 scaleExtents 中约束的“zoom”事件上调用缩放</span></span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">zoomListener</span> = d3.<span class="property">behavior</span>.<span class="title function_">zoom</span>().<span class="title function_">scaleExtent</span>([<span class="number">0.1</span>, <span class="number">3</span>]).<span class="title function_">on</span>(<span class="string">&quot;zoom&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">zoom</span>()</span><br><span class="line">     &#125;);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//创建视图</span></span><br><span class="line">     <span class="keyword">const</span> baseSvg = d3.<span class="title function_">select</span>(<span class="string">&quot;#tree-container&quot;</span>)</span><br><span class="line">         .<span class="title function_">append</span>(<span class="string">&#x27;svg&#x27;</span>)</span><br><span class="line">         .<span class="title function_">attr</span>(<span class="string">&#x27;width&#x27;</span>, <span class="variable language_">this</span>.<span class="property">viewerWidth</span>)</span><br><span class="line">         .<span class="title function_">attr</span>(<span class="string">&#x27;height&#x27;</span>, <span class="variable language_">this</span>.<span class="property">viewerHeight</span>)</span><br><span class="line">         .<span class="title function_">attr</span>(<span class="string">&quot;class&quot;</span>,<span class="string">&quot;overlay&quot;</span>)</span><br><span class="line">         .<span class="title function_">append</span>(<span class="string">&quot;g&quot;</span>)</span><br><span class="line">         .<span class="title function_">call</span>(<span class="variable language_">this</span>.<span class="property">zoomListener</span>)</span><br><span class="line"></span><br><span class="line">     <span class="keyword">let</span> dragListener = d3.<span class="property">behavior</span>.<span class="title function_">drag</span>()</span><br><span class="line">         .<span class="title function_">on</span>(<span class="string">&quot;dragstart&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (d === <span class="variable language_">this</span>.<span class="property">root</span>) &#123;</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="property">dragStarted</span> = <span class="literal">true</span>;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="property">nodes</span> = <span class="variable language_">this</span>.<span class="property">tree</span>.<span class="title function_">nodes</span>(d);</span><br><span class="line">           d3.<span class="property">event</span>.<span class="property">sourceEvent</span>.<span class="title function_">stopPropagation</span>();</span><br><span class="line">         &#125;).<span class="title function_">on</span>(<span class="string">&quot;drag&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (d === <span class="variable language_">this</span>.<span class="property">root</span>) &#123;</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">dragStarted</span>) &#123;</span><br><span class="line">             <span class="keyword">let</span> domNode = <span class="variable language_">this</span>;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">initiateDrag</span>(d, domNode);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//获取mouseEvent相对于SVG容器的同弦以允许摇摄</span></span><br><span class="line">           <span class="keyword">let</span> relCoords = d3.<span class="title function_">mouse</span>($(<span class="string">&#x27;svg&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>));</span><br><span class="line">           <span class="keyword">if</span> (relCoords[<span class="number">0</span>] &lt; <span class="variable language_">this</span>.<span class="property">panBoundary</span>)&#123;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="property">panTimer</span> = <span class="literal">true</span>;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">pan</span>(<span class="variable language_">this</span>, <span class="string">&#x27;left&#x27;</span>);</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span> (relCoords[<span class="number">0</span>] &gt; ($(<span class="string">&#x27;svg&#x27;</span>).<span class="title function_">width</span>() - <span class="variable language_">this</span>.<span class="property">panBoundary</span>)) &#123;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="property">panTimer</span> = <span class="literal">true</span>;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">pan</span>(<span class="variable language_">this</span>, <span class="string">&#x27;right&#x27;</span>);</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span> (relCoords[<span class="number">1</span>] &lt; <span class="variable language_">this</span>.<span class="property">panBoundary</span>) &#123;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="property">panTimer</span> = <span class="literal">true</span>;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">pan</span>(<span class="variable language_">this</span>, <span class="string">&#x27;up&#x27;</span>);</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span> (relCoords[<span class="number">1</span>] &gt; ($(<span class="string">&#x27;svg&#x27;</span>).<span class="title function_">height</span>() - <span class="variable language_">this</span>.<span class="property">panBoundary</span>)) &#123;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="property">panTimer</span> = <span class="literal">true</span>;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">pan</span>(<span class="variable language_">this</span>, <span class="string">&#x27;down&#x27;</span>);</span><br><span class="line">           &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">panTimer</span>);</span><br><span class="line">             &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           d.<span class="property">x0</span> += d3.<span class="property">event</span>.<span class="property">dy</span>;</span><br><span class="line">           d.<span class="property">y0</span> += d3.<span class="property">event</span>.<span class="property">dx</span>;</span><br><span class="line">           <span class="keyword">var</span> node = d3.<span class="title function_">select</span>(<span class="variable language_">this</span>);</span><br><span class="line">           node.<span class="title function_">attr</span>(<span class="string">&quot;transform&quot;</span>, <span class="string">&quot;translate(&quot;</span> + d.<span class="property">y0</span> + <span class="string">&quot;,&quot;</span> + d.<span class="property">x0</span> + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">           <span class="comment">//更新临时连接器</span></span><br><span class="line">           <span class="variable language_">this</span>.<span class="title function_">updateTempConnector</span>();</span><br><span class="line">         &#125;).<span class="title function_">on</span>(<span class="string">&quot;dragend&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (d === <span class="variable language_">this</span>.<span class="property">root</span>) &#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="property">domNode</span> = <span class="variable language_">this</span>;</span><br><span class="line">           <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">selectedNode</span>)&#123;</span><br><span class="line">             <span class="keyword">var</span> index = <span class="variable language_">this</span>.<span class="property">draggingNode</span>.<span class="property">parent</span>.<span class="property">children</span>.<span class="title function_">indexOf</span>(<span class="variable language_">this</span>.<span class="property">draggingNode</span>);</span><br><span class="line">             <span class="keyword">if</span> (index &gt; -<span class="number">1</span> )&#123;</span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">draggingNode</span>.<span class="property">parent</span>.<span class="property">children</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">children</span> !== <span class="string">&quot;undefined&quot;</span> || <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">_children</span> !== <span class="string">&#x27;undefined&#x27;</span>)&#123;</span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">_children</span> !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">                 <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">children</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">draggingNode</span>)</span><br><span class="line">               &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">_children</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">draggingNode</span>)</span><br><span class="line">               &#125;</span><br><span class="line">             &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">children</span> = []</span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">children</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">draggingNode</span>)</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">//确保要添加到的节点已展开，以便用户可以看到添加的节点已正确移动</span></span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">expand</span>(<span class="variable language_">this</span>.<span class="property">selectedNode</span>);</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">sortTree</span>();</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">endDrag</span>();</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">endDrag</span>();</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">     <span class="comment">//附加一个包含所有节点的组，缩放侦听器可以对其进行操作。</span></span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">svgGroup</span> = baseSvg.<span class="title function_">append</span>(<span class="string">&quot;g&quot;</span>);</span><br><span class="line">     <span class="comment">//移除双击</span></span><br><span class="line">     d3.<span class="title function_">select</span>(<span class="string">&quot;svg&quot;</span>).<span class="title function_">on</span>(<span class="string">&quot;dblclick.zoom&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">root</span> = <span class="variable language_">this</span>.<span class="property">treeData</span>;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">root</span>.<span class="property">x0</span> = <span class="variable language_">this</span>.<span class="property">viewerHeight</span>/<span class="number">2</span>;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">root</span>.<span class="property">y0</span> = <span class="number">0</span>;</span><br><span class="line">     <span class="comment">//最初布局树并以根节点为中心。</span></span><br><span class="line"></span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">root</span>.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="variable language_">this</span>.<span class="property">collapse</span>);</span><br><span class="line">     <span class="variable language_">this</span>.<span class="title function_">update</span>(<span class="variable language_">this</span>.<span class="property">root</span>);</span><br><span class="line">     <span class="variable language_">this</span>.<span class="title function_">centerNode</span>(<span class="variable language_">this</span>.<span class="property">root</span>);</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">update</span>(<span class="params">source</span>)&#123;</span><br><span class="line">      <span class="keyword">var</span> width = <span class="number">130</span>,</span><br><span class="line">          height = <span class="number">70</span>;</span><br><span class="line">      <span class="comment">//计算新 树图的布局</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">nodes</span> = <span class="variable language_">this</span>.<span class="property">tree</span>.<span class="title function_">nodes</span>(<span class="variable language_">this</span>.<span class="property">root</span>).<span class="title function_">reverse</span>();</span><br><span class="line">      <span class="keyword">let</span> links = <span class="variable language_">this</span>.<span class="property">tree</span>.<span class="title function_">links</span>(<span class="variable language_">this</span>.<span class="property">nodes</span>)</span><br><span class="line">      <span class="comment">//设置y坐标点  每层占  200px；</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">nodes</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">d</span>=&gt;</span>&#123;</span><br><span class="line">        d.<span class="property">y</span>=d.<span class="property">depth</span> * <span class="number">200</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">//每个node对应一个group</span></span><br><span class="line">      <span class="comment">//data()：绑定一个数组到选择集上，数组的各项值分别与选择集的各元素绑定</span></span><br><span class="line">      <span class="keyword">let</span> node = <span class="variable language_">this</span>.<span class="property">svgGroup</span>.<span class="title function_">selectAll</span>(<span class="string">&quot;g.node&quot;</span>)</span><br><span class="line">          .<span class="title function_">data</span>(<span class="variable language_">this</span>.<span class="property">nodes</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> d.<span class="property">id</span> || (d.<span class="property">id</span> = ++ <span class="variable language_">this</span>.<span class="property">i</span>)</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//新增节点数据集，设置位置</span></span><br><span class="line">      <span class="comment">//在 svg 中添加一个g，g是 svg 中的一个属性，是 group 的意思，</span></span><br><span class="line">      <span class="comment">// 它表示一组什么东西，如一组 lines ， rects ，circles</span></span><br><span class="line">      <span class="comment">// 其实坐标轴就是由这些东西构成的。</span></span><br><span class="line">      <span class="keyword">let</span> nodeEnter = node.<span class="title function_">enter</span>().<span class="title function_">append</span>(<span class="string">&quot;g&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;node&quot;</span>) <span class="comment">//attr设置html属性，style设置css属性</span></span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;transform&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;translate(&quot;</span> + source.<span class="property">y0</span> + <span class="string">&quot;,&quot;</span> + source.<span class="property">x0</span> + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">          &#125;).<span class="title function_">on</span>(<span class="string">&quot;dblclick&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123; <span class="variable language_">this</span>.<span class="title function_">click</span>(d) &#125;);</span><br><span class="line">      <span class="comment">//添加连接点---此处设置的是圆圈过渡时候的效果（颜色）</span></span><br><span class="line">      nodeEnter.<span class="title function_">append</span>(<span class="string">&quot;rect&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;x&quot;</span>, -<span class="number">65</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;y&quot;</span>,-<span class="number">35</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;width&quot;</span>, width)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;height&quot;</span>, height)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;rx&quot;</span>, <span class="number">10</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill&quot;</span>, <span class="string">&quot;#FFF&quot;</span>); <span class="comment">//d 代表数据，也就是与某元素绑定的数据。</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//指标名称</span></span><br><span class="line">      nodeEnter.<span class="title function_">append</span>(<span class="string">&quot;text&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;x&quot;</span>, <span class="number">0</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;dy&quot;</span>, -<span class="number">20</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;text-anchor&quot;</span>, <span class="string">&quot;middle&quot;</span>)</span><br><span class="line">          .<span class="title function_">text</span>(<span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> d.<span class="property">name</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill&quot;</span>, <span class="string">&quot;gray&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill-opacity&quot;</span>, <span class="number">1</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;font-size&quot;</span>, <span class="string">&quot;12px&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//指标值</span></span><br><span class="line">      nodeEnter.<span class="title function_">append</span>(<span class="string">&quot;text&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;x&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> d.<span class="property">children</span> || d.<span class="property">_children</span> ? -<span class="number">15</span> : -<span class="number">15</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;dy&quot;</span>, <span class="number">0</span>)</span><br><span class="line">          <span class="comment">// .attr(&quot;text-anchor&quot;, (d) &#123; return d.children || d._children ? &quot;end&quot; : &quot;start&quot;; &#125;)</span></span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;text-anchor&quot;</span>, <span class="string">&quot;middle&quot;</span>)</span><br><span class="line">          .<span class="title function_">text</span>(<span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> d.<span class="property">value</span>.<span class="title function_">toLocaleString</span>();</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill&quot;</span>, <span class="string">&quot;blue&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;font-size&quot;</span>, <span class="string">&quot;18px&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">//指标单位</span></span><br><span class="line">      nodeEnter.<span class="title function_">append</span>(<span class="string">&quot;text&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;x&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> d.<span class="property">children</span> || d.<span class="property">_children</span> ? d.<span class="property">value</span> != <span class="literal">null</span> ? d.<span class="property">value</span>.<span class="title function_">toString</span>().<span class="property">length</span> * <span class="number">6</span> - <span class="number">4</span> : <span class="number">10</span> : d.<span class="property">value</span> != <span class="literal">null</span> ? d.<span class="property">value</span>.<span class="title function_">toString</span>().<span class="property">length</span> * <span class="number">6</span> - <span class="number">4</span> : <span class="number">10</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;dy&quot;</span>, -<span class="number">3</span>)</span><br><span class="line">          <span class="comment">// .attr(&quot;text-anchor&quot;, (d) &#123; return d.children || d._children ? &quot;end&quot; : &quot;start&quot;; &#125;)</span></span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;text-anchor&quot;</span>, <span class="string">&quot;middle&quot;</span>)</span><br><span class="line">          .<span class="title function_">text</span>(<span class="string">&quot;万元&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill&quot;</span>, <span class="string">&quot;gray&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;font-size&quot;</span>, <span class="string">&quot;10px&quot;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">//展开趋势图</span></span><br><span class="line">      nodeEnter.<span class="title function_">append</span>(<span class="string">&quot;text&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;x&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> d.<span class="property">children</span> || d.<span class="property">_children</span> ? <span class="number">50</span> : <span class="number">50</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;dy&quot;</span>, <span class="number">0</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;text-anchor&quot;</span>, <span class="string">&quot;middle&quot;</span>)</span><br><span class="line">          .<span class="title function_">text</span>(<span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;...&quot;</span></span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill&quot;</span>, <span class="string">&quot;gray&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill-opacity&quot;</span>, <span class="number">1</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;font-size&quot;</span>, <span class="string">&quot;28px&quot;</span>)</span><br><span class="line">          .<span class="title function_">on</span>(<span class="string">&quot;click&quot;</span>, <span class="function">(<span class="params">d, i</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;触发点击事件&quot;</span>)</span><br><span class="line">          &#125;);</span><br><span class="line">      <span class="comment">// Transition nodes to their new position.将节点过渡到一个新的位置-----主要是针对节点过渡过程中的过渡效果</span></span><br><span class="line">      <span class="comment">//node就是保留的数据集，为原来数据的图形添加过渡动画。首先是整个组的位置</span></span><br><span class="line">      <span class="comment">//子节点全出来了</span></span><br><span class="line">      <span class="keyword">var</span> nodeUpdate = node.<span class="title function_">transition</span>() <span class="comment">//开始一个动画过度</span></span><br><span class="line">          .<span class="title function_">duration</span>(<span class="variable language_">this</span>.<span class="property">duration</span>) <span class="comment">//过渡延迟时间 此处主要设置的是圆圈节点随斜线的过渡延迟</span></span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;transform&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;translate(&quot;</span> + d.<span class="property">y</span> + <span class="string">&quot;,&quot;</span> + d.<span class="property">x</span> + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">      nodeUpdate.<span class="title function_">select</span>(<span class="string">&quot;rect&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;x&quot;</span>, -<span class="number">65</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;y&quot;</span>, -<span class="number">35</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;width&quot;</span>, width)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;height&quot;</span>, height/<span class="number">2</span> + <span class="number">10</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;rx&quot;</span>, <span class="number">10</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill&quot;</span>, <span class="string">&quot;#FFF&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;stroke&quot;</span>,<span class="keyword">function</span>(<span class="params">d</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(d.<span class="property">value</span> === <span class="number">0</span>)&#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="string">&#x27;#6b6b6b&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;steelblue&#x27;</span></span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;stroke-width&quot;</span>, <span class="string">&quot;1.5px&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Transition exiting nodes to the parent&#x27;s new position.过渡现有的节点到父母的新位置。</span></span><br><span class="line">      <span class="comment">//最后处理消失的数据，添加消失动画</span></span><br><span class="line">      <span class="keyword">var</span> nodeExit = node.<span class="title function_">exit</span>().<span class="title function_">transition</span>()</span><br><span class="line">          .<span class="title function_">duration</span>(<span class="variable language_">this</span>.<span class="property">duration</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;transform&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;translate(&quot;</span> + source.<span class="property">y</span> + <span class="string">&quot;,&quot;</span> + source.<span class="property">x</span> + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">remove</span>();</span><br><span class="line"></span><br><span class="line">      nodeExit.<span class="title function_">select</span>(<span class="string">&quot;rect&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;x&quot;</span>, -<span class="number">65</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;y&quot;</span>, -<span class="number">35</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;width&quot;</span>, width)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;height&quot;</span>, height/<span class="number">2</span> +<span class="number">10</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;rx&quot;</span>, <span class="number">10</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill&quot;</span>, <span class="string">&quot;#FFF&quot;</span>);</span><br><span class="line"></span><br><span class="line">      nodeExit.<span class="title function_">select</span>(<span class="string">&quot;text&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;text-anchor&quot;</span>, <span class="string">&quot;middle&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill-opacity&quot;</span>, <span class="number">1e-6</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update the links…线操作相关</span></span><br><span class="line">      <span class="comment">//再处理连线集合</span></span><br><span class="line">      <span class="keyword">let</span> link = <span class="variable language_">this</span>.<span class="property">svgGroup</span>.<span class="title function_">selectAll</span>(<span class="string">&quot;path.link&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill&quot;</span>, <span class="string">&quot;none&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;stroke&quot;</span>, <span class="string">&quot;steelblue&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;stroke-width&quot;</span>, <span class="string">&quot;1.5px&quot;</span>)</span><br><span class="line">          .<span class="title function_">data</span>(links, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> d.<span class="property">target</span>.<span class="property">id</span>;</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Enter any new links at the parent&#x27;s previous position.</span></span><br><span class="line">      <span class="comment">//添加新的连线</span></span><br><span class="line"></span><br><span class="line">      link.<span class="title function_">enter</span>().<span class="title function_">insert</span>(<span class="string">&quot;path&quot;</span>, <span class="string">&quot;g&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;fill&quot;</span>, <span class="string">&quot;none&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;stroke&quot;</span>, <span class="string">&quot;steelblue&quot;</span>)</span><br><span class="line">          .<span class="title function_">style</span>(<span class="string">&quot;stroke-width&quot;</span>, <span class="string">&quot;1.5px&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;link&quot;</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;d&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> o = &#123;</span><br><span class="line">              <span class="attr">x</span>: source.<span class="property">x0</span>,</span><br><span class="line">              <span class="attr">y</span>: source.<span class="property">y0</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">diagonal</span>(&#123;</span><br><span class="line">              <span class="attr">source</span>: o,</span><br><span class="line">              <span class="attr">target</span>: o</span><br><span class="line">            &#125;); <span class="comment">//diagonal - 生成一个二维贝塞尔连接器, 用于节点连接图.</span></span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&#x27;marker-end&#x27;</span>, <span class="string">&#x27;url(#arrow)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Transition links to their new position.将斜线过渡到新的位置</span></span><br><span class="line">      <span class="comment">//保留的连线添加过渡动画</span></span><br><span class="line">      link.<span class="title function_">transition</span>()</span><br><span class="line">          .<span class="title function_">duration</span>(<span class="variable language_">this</span>.<span class="property">duration</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;d&quot;</span>, <span class="variable language_">this</span>.<span class="property">diagonal</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Transition exiting nodes to the parent&#x27;s new position.过渡现有的斜线到父母的新位置。</span></span><br><span class="line">      <span class="comment">//消失的连线添加过渡动画</span></span><br><span class="line">      link.<span class="title function_">exit</span>().<span class="title function_">transition</span>()</span><br><span class="line">          .<span class="title function_">duration</span>(<span class="variable language_">this</span>.<span class="property">duration</span>)</span><br><span class="line">          .<span class="title function_">attr</span>(<span class="string">&quot;d&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> o = &#123;</span><br><span class="line">              <span class="attr">x</span>: source.<span class="property">x</span>,</span><br><span class="line">              <span class="attr">y</span>: source.<span class="property">y</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">diagonal</span>(&#123;</span><br><span class="line">              <span class="attr">source</span>: o,</span><br><span class="line">              <span class="attr">target</span>: o</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">remove</span>();</span><br><span class="line">      <span class="comment">// Stash the old positions for transition.将旧的斜线过渡效果隐藏</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">nodes</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">        d.<span class="property">x0</span> = d.<span class="property">x</span>;</span><br><span class="line">        d.<span class="property">y0</span> = d.<span class="property">y</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure><p>双击收展方法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//展开节点</span></span><br><span class="line"><span class="comment">//children 展示节点 _children 隐藏节点  缩</span></span><br><span class="line">    <span class="title function_">expand</span>(<span class="params">d</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (d.<span class="property">_children</span>)&#123;</span><br><span class="line">        d.<span class="property">children</span> = d.<span class="property">_children</span>;</span><br><span class="line">        d.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="variable language_">this</span>.<span class="property">expand</span>)</span><br><span class="line">        d.<span class="property">_children</span> = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">        </span><br><span class="line"><span class="comment">//收缩节点</span></span><br><span class="line">    <span class="title function_">collapse</span>(<span class="params">d</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (d.<span class="property">children</span>)&#123;</span><br><span class="line">        d.<span class="property">_children</span>=d.<span class="property">children</span>;</span><br><span class="line">        d.<span class="property">children</span>=<span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure><p>根据数据判断层数：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断是否多层</span></span><br><span class="line"><span class="title function_">treeDepths</span>(<span class="params">g</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> depths = [];</span><br><span class="line">  <span class="keyword">if</span> (g.<span class="property">children</span>)</span><br><span class="line">    g.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">dfs</span>(v, <span class="number">1</span>, depths);</span><br><span class="line">    &#125;);</span><br><span class="line">  <span class="keyword">return</span> depths;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">//嵌套循环</span></span><br><span class="line"><span class="title function_">dfs</span>(<span class="params">v, depth, depths</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> children = v.<span class="property">children</span>;</span><br><span class="line">  <span class="keyword">if</span> (children &amp;&amp; children.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    children.<span class="title function_">forEach</span>(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">dfs</span>(child, depth + <span class="number">1</span>, depths);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    depths.<span class="title function_">push</span>(v);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>排序节点：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//排序</span></span><br><span class="line"><span class="title function_">sortTree</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==排序开始==&quot;</span>)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">tree</span>.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> b.<span class="property">name</span> ? b.<span class="property">name</span>.<span class="title function_">toLowerCase</span>() : b.<span class="property">name</span> &lt; a.<span class="property">name</span> ? a.<span class="property">name</span>.<span class="title function_">toLowerCase</span>() : a.<span class="property">name</span> ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>拖拉行为：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">zoom</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">svgGroup</span>.<span class="title function_">attr</span>(<span class="string">&quot;transform&quot;</span>, <span class="string">&quot;translate(&quot;</span> + d3.<span class="property">event</span>.<span class="property">translate</span> + <span class="string">&quot;)scale(&quot;</span> + d3.<span class="property">event</span>.<span class="property">scale</span> + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">&#125;,</span><br><span class="line">    </span><br><span class="line">      <span class="comment">//拖拽开始时对节点进行一系列操作，以确保拖拽过程中节点的正确显示和相关连线的调整。</span></span><br><span class="line"><span class="title function_">initiateDrag</span>(<span class="params">d, domNode</span>) &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  将当前被拖拽的节点保存在this.draggingNode属性中，</span></span><br><span class="line"><span class="comment">  以便在拖拽过程中能够对其进行操作</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">draggingNode</span> = d;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  1=</span></span><br><span class="line"><span class="comment">  为了将被拖拽节点的.ghostCircle元素的</span></span><br><span class="line"><span class="comment">  pointer-events属性设置为none，</span></span><br><span class="line"><span class="comment">  以避免拖拽节点时干扰到其他元素</span></span><br><span class="line"><span class="comment">  2=</span></span><br><span class="line"><span class="comment">  为了将所有.ghostCircle元素的类设置为ghostCircle show，</span></span><br><span class="line"><span class="comment">  这可能是用于显示拖拽节点周围的虚拟元素</span></span><br><span class="line"><span class="comment">  3=为了为被拖拽的节点设置类名，可能是用于在拖拽过程中应用特定的样式</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  d3.<span class="title function_">select</span>(domNode).<span class="title function_">select</span>(<span class="string">&#x27;.ghostCircle&#x27;</span>).<span class="title function_">attr</span>(<span class="string">&#x27;pointer-events&#x27;</span>, <span class="string">&#x27;none&#x27;</span>);</span><br><span class="line">  d3.<span class="title function_">selectAll</span>(<span class="string">&#x27;.ghostCircle&#x27;</span>).<span class="title function_">attr</span>(<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;ghostCircle show&#x27;</span>);</span><br><span class="line">  d3.<span class="title function_">select</span>(domNode).<span class="title function_">attr</span>(<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;node activeDrag&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  重新排序所有节点，将被拖拽的节点置于最前面，</span></span><br><span class="line"><span class="comment">  以确保它能够在拖拽过程中正确显示在其他节点之上</span></span><br><span class="line"><span class="comment">  选择父项并对路径的</span></span><br><span class="line"><span class="comment">  a 不是悬停元素，将“a”发送到后面</span></span><br><span class="line"><span class="comment">  a 是悬停元素，将“a”放在前面</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">svgGroup</span>.<span class="title function_">selectAll</span>(<span class="string">&quot;g.node&quot;</span>).<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123; <span class="comment">// select the parent and sort the path&#x27;s</span></span><br><span class="line">    <span class="keyword">if</span> (a.<span class="property">id</span> !== <span class="variable language_">this</span>.<span class="property">draggingNode</span>.<span class="property">id</span>) <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// a is not the hovered element, send &quot;a&quot; to the back</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">// a is the hovered element, bring &quot;a&quot; to the front</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 如果节点有子节点，请删除链接和节点</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">nodes</span>.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// remove link paths 删除链接路径</span></span><br><span class="line">    <span class="keyword">let</span> links = <span class="variable language_">this</span>.<span class="property">tree</span>.<span class="title function_">links</span>(<span class="variable language_">this</span>.<span class="property">nodes</span>);</span><br><span class="line">    <span class="keyword">let</span> nodePaths = <span class="variable language_">this</span>.<span class="property">svgGroup</span>.<span class="title function_">selectAll</span>(<span class="string">&quot;path.link&quot;</span>)</span><br><span class="line">        .<span class="title function_">data</span>(links, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> d.<span class="property">target</span>.<span class="property">id</span>;</span><br><span class="line">        &#125;).<span class="title function_">remove</span>();</span><br><span class="line">    <span class="comment">// remove child nodes 删除子节点</span></span><br><span class="line">    <span class="keyword">let</span> nodesExit = <span class="variable language_">this</span>.<span class="property">svgGroup</span>.<span class="title function_">selectAll</span>(<span class="string">&quot;g.node&quot;</span>)</span><br><span class="line">        .<span class="title function_">data</span>(<span class="variable language_">this</span>.<span class="property">nodes</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> d.<span class="property">id</span>;</span><br><span class="line">        &#125;).<span class="title function_">filter</span>(<span class="function">(<span class="params">d, i</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (d.<span class="property">id</span> === <span class="variable language_">this</span>.<span class="property">draggingNode</span>.<span class="property">id</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;).<span class="title function_">remove</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove parent link</span></span><br><span class="line">  <span class="keyword">let</span> parentLink = <span class="variable language_">this</span>.<span class="property">tree</span>.<span class="title function_">links</span>(<span class="variable language_">this</span>.<span class="property">tree</span>.<span class="title function_">nodes</span>(<span class="variable language_">this</span>.<span class="property">draggingNode</span>.<span class="property">parent</span>));</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">svgGroup</span>.<span class="title function_">selectAll</span>(<span class="string">&#x27;path.link&#x27;</span>).<span class="title function_">filter</span>(<span class="function">(<span class="params">d, i</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (d.<span class="property">target</span>.<span class="property">id</span> === <span class="variable language_">this</span>.<span class="property">draggingNode</span>.<span class="property">id</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;).<span class="title function_">remove</span>();</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dragStarted</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//更新指示拖动隶属关系的临时连接器</span></span><br><span class="line"><span class="title function_">updateTempConnector</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> data = [];</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">draggingNode</span> !== <span class="literal">null</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">selectedNode</span> !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// have to flip the source coordinates since we did this for the existing connectors on the original tree</span></span><br><span class="line">    data = [&#123;</span><br><span class="line">      <span class="attr">source</span>: &#123;</span><br><span class="line">        <span class="attr">x</span>: <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">y0</span>,</span><br><span class="line">        <span class="attr">y</span>: <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">x0</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">target</span>: &#123;</span><br><span class="line">        <span class="attr">x</span>: <span class="variable language_">this</span>.<span class="property">draggingNode</span>.<span class="property">y0</span>,</span><br><span class="line">        <span class="attr">y</span>: <span class="variable language_">this</span>.<span class="property">draggingNode</span>.<span class="property">x0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> link = <span class="variable language_">this</span>.<span class="property">svgGroup</span>.<span class="title function_">selectAll</span>(<span class="string">&quot;.templink&quot;</span>).<span class="title function_">data</span>(data);</span><br><span class="line"></span><br><span class="line">  link.<span class="title function_">enter</span>().<span class="title function_">append</span>(<span class="string">&quot;path&quot;</span>)</span><br><span class="line">      .<span class="title function_">attr</span>(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;templink&quot;</span>)</span><br><span class="line">      .<span class="title function_">attr</span>(<span class="string">&quot;d&quot;</span>, d3.<span class="property">svg</span>.<span class="title function_">diagonal</span>())</span><br><span class="line">      .<span class="title function_">attr</span>(<span class="string">&#x27;pointer-events&#x27;</span>, <span class="string">&#x27;none&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  link.<span class="title function_">attr</span>(<span class="string">&quot;d&quot;</span>, d3.<span class="property">svg</span>.<span class="title function_">diagonal</span>());</span><br><span class="line"></span><br><span class="line">  link.<span class="title function_">exit</span>().<span class="title function_">remove</span>();</span><br><span class="line">&#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="d3-方法介绍">d3 方法介绍</h2><h4 id="append">append()</h4><p><code>.append('svg')</code>和<code>.append('g')</code>是D3中的方法，用于在DOM中添加SVG元素和G元素。</p><p><code>.append('svg')</code>方法用于在选定的DOM元素中添加一个SVG元素。SVG（可缩放矢量图形）是一种用于在Web上显示矢量图形的XML语言。通过使用<code>.append('svg')</code>方法，你可以在DOM中创建一个包含SVG图形的容器，以便在其中绘制图形、添加元素等。例如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javascript复制d3.<span class="title function_">select</span>(<span class="string">&#x27;body&#x27;</span>).<span class="title function_">append</span>(<span class="string">&#x27;svg&#x27;</span>)</span><br><span class="line">  .<span class="title function_">attr</span>(<span class="string">&#x27;width&#x27;</span>, <span class="number">500</span>)</span><br><span class="line">  .<span class="title function_">attr</span>(<span class="string">&#x27;height&#x27;</span>, <span class="number">300</span>);</span><br></pre></td></tr></table></figure><p>上述代码在<code>&lt;body&gt;</code>元素中添加了一个SVG元素，并设置宽度为500像素、高度为300像素。</p><p><code>.append('g')</code>方法用于在已经存在的SVG元素中添加一个G元素。G元素是SVG中的分组元素，可以用于组织和管理其他SVG元素。你可以将G元素看作是一个容器，可以在其中放置其他SVG元素，然后对整个组进行变换、样式设置等操作。例如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">javascript复制<span class="keyword">const</span> svg = d3.<span class="title function_">select</span>(<span class="string">&#x27;body&#x27;</span>).<span class="title function_">append</span>(<span class="string">&#x27;svg&#x27;</span>)</span><br><span class="line">  .<span class="title function_">attr</span>(<span class="string">&#x27;width&#x27;</span>, <span class="number">500</span>)</span><br><span class="line">  .<span class="title function_">attr</span>(<span class="string">&#x27;height&#x27;</span>, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> g = svg.<span class="title function_">append</span>(<span class="string">&#x27;g&#x27;</span>)</span><br><span class="line">  .<span class="title function_">attr</span>(<span class="string">&#x27;transform&#x27;</span>, <span class="string">&#x27;translate(50, 50)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">g.<span class="title function_">append</span>(<span class="string">&#x27;rect&#x27;</span>)</span><br><span class="line">  .<span class="title function_">attr</span>(<span class="string">&#x27;width&#x27;</span>, <span class="number">100</span>)</span><br><span class="line">  .<span class="title function_">attr</span>(<span class="string">&#x27;height&#x27;</span>, <span class="number">50</span>)</span><br><span class="line">  .<span class="title function_">attr</span>(<span class="string">&#x27;fill&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>);</span><br></pre></td></tr></table></figure><p>上述代码先在<code>&lt;body&gt;</code>元素中添加了一个SVG元素，然后在SVG元素中添加了一个G元素，设置了G元素的平移变换，最后在G元素中添加了一个矩形元素。</p><p>希望解答了你的问题。如果还有其他疑问，请随时提出。</p><h5 id="d3.behavior.drag">d3.behavior.drag()</h5><ol type="1"><li><code>dragstart</code>：当拖拽开始时触发。在这个回调函数中，首先判断拖拽的目标节点<code>d</code>是否为根节点<code>this.root</code>。如果是根节点，则直接返回，不执行后续的拖拽操作。否则，将<code>this.dragStarted</code>标志设置为<code>true</code>，并获取该节点的所有子节点。最后，通过<code>d3.event.sourceEvent.stopPropagation()</code>阻止事件继续传播。</li><li><code>drag</code>：当拖拽过程中持续触发。在这个回调函数中，首先判断拖拽的目标节点<code>d</code>是否为根节点<code>this.root</code>。如果是根节点，则直接返回，不执行后续的拖拽操作。接下来，如果<code>this.dragStarted</code>为<code>true</code>，则调用<code>initiateDrag()</code>方法来初始化拖拽操作。然后，获取鼠标事件相对于SVG容器的坐标，并根据坐标来判断是否需要进行平移操作。最后，更新目标节点的位置，并调用<code>updateTempConnector()</code>方法更新临时连接器。</li><li><code>dragend</code>：当拖拽结束时触发。在这个回调函数中，首先判断拖拽的目标节点<code>d</code>是否为根节点<code>this.root</code>，如果是根节点，则直接返回。接下来，将<code>this.domNode</code>设置为当前节点，并判断是否有选中的节点<code>this.selectedNode</code>。如果有选中的节点，则将被拖拽的节点<code>this.draggingNode</code>从其父节点中移除，并将其添加到选中的节点的子节点或子节点集合中，然后展开选中的节点，对树进行排序，并结束拖拽操作。如果没有选中的节点，则直接结束拖拽操作。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dragListener = d3.<span class="property">behavior</span>.<span class="title function_">drag</span>()</span><br><span class="line">          .<span class="title function_">on</span>(<span class="string">&quot;dragstart&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (d === <span class="variable language_">this</span>.<span class="property">root</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dragStarted</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">nodes</span> = <span class="variable language_">this</span>.<span class="property">tree</span>.<span class="title function_">nodes</span>(d);</span><br><span class="line">            d3.<span class="property">event</span>.<span class="property">sourceEvent</span>.<span class="title function_">stopPropagation</span>();</span><br><span class="line">          &#125;).<span class="title function_">on</span>(<span class="string">&quot;drag&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (d === <span class="variable language_">this</span>.<span class="property">root</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">dragStarted</span>) &#123;</span><br><span class="line">              <span class="keyword">let</span> domNode = <span class="variable language_">this</span>;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">initiateDrag</span>(d, domNode);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取mouseEvent相对于SVG容器的同弦以允许摇摄</span></span><br><span class="line">            <span class="keyword">let</span> relCoords = d3.<span class="title function_">mouse</span>($(<span class="string">&#x27;svg&#x27;</span>).<span class="title function_">get</span>(<span class="number">0</span>));</span><br><span class="line">            <span class="keyword">if</span> (relCoords[<span class="number">0</span>] &lt; <span class="variable language_">this</span>.<span class="property">panBoundary</span>)&#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">panTimer</span> = <span class="literal">true</span>;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">pan</span>(<span class="variable language_">this</span>, <span class="string">&#x27;left&#x27;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (relCoords[<span class="number">0</span>] &gt; ($(<span class="string">&#x27;svg&#x27;</span>).<span class="title function_">width</span>() - <span class="variable language_">this</span>.<span class="property">panBoundary</span>)) &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">panTimer</span> = <span class="literal">true</span>;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">pan</span>(<span class="variable language_">this</span>, <span class="string">&#x27;right&#x27;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (relCoords[<span class="number">1</span>] &lt; <span class="variable language_">this</span>.<span class="property">panBoundary</span>) &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">panTimer</span> = <span class="literal">true</span>;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">pan</span>(<span class="variable language_">this</span>, <span class="string">&#x27;up&#x27;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (relCoords[<span class="number">1</span>] &gt; ($(<span class="string">&#x27;svg&#x27;</span>).<span class="title function_">height</span>() - <span class="variable language_">this</span>.<span class="property">panBoundary</span>)) &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">panTimer</span> = <span class="literal">true</span>;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">pan</span>(<span class="variable language_">this</span>, <span class="string">&#x27;down&#x27;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">panTimer</span>);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            d.<span class="property">x0</span> += d3.<span class="property">event</span>.<span class="property">dy</span>;</span><br><span class="line">            d.<span class="property">y0</span> += d3.<span class="property">event</span>.<span class="property">dx</span>;</span><br><span class="line">            <span class="keyword">var</span> node = d3.<span class="title function_">select</span>(<span class="variable language_">this</span>);</span><br><span class="line">            node.<span class="title function_">attr</span>(<span class="string">&quot;transform&quot;</span>, <span class="string">&quot;translate(&quot;</span> + d.<span class="property">y0</span> + <span class="string">&quot;,&quot;</span> + d.<span class="property">x0</span> + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">updateTempConnector</span>();</span><br><span class="line">          &#125;).<span class="title function_">on</span>(<span class="string">&quot;dragend&quot;</span>, <span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (d === <span class="variable language_">this</span>.<span class="property">root</span>) &#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">domNode</span> = <span class="variable language_">this</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">selectedNode</span>)&#123;</span><br><span class="line">              <span class="keyword">var</span> index = <span class="variable language_">this</span>.<span class="property">draggingNode</span>.<span class="property">parent</span>.<span class="property">children</span>.<span class="title function_">indexOf</span>(<span class="variable language_">this</span>.<span class="property">draggingNode</span>);</span><br><span class="line">              <span class="keyword">if</span> (index &gt; -<span class="number">1</span> )&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">draggingNode</span>.<span class="property">parent</span>.<span class="property">children</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">children</span> !== <span class="string">&quot;undefined&quot;</span> || <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">_children</span> !== <span class="string">&#x27;undefined&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">_children</span> !== <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">                  <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">children</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">draggingNode</span>)</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">_children</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">draggingNode</span>)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">children</span> = []</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">selectedNode</span>.<span class="property">children</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">draggingNode</span>)</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">//确保要添加到的节点已展开，以便用户可以看到添加的节点已正确移动</span></span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">expand</span>(<span class="variable language_">this</span>.<span class="property">selectedNode</span>);</span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">sortTree</span>();</span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">endDrag</span>();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">endDrag</span>();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br></pre></td></tr></table></figure><h2 id="end-完整代码">End 完整代码</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div block :scroll=&quot;true&quot;&gt;</span><br><span class="line">    &lt;div style=&quot;background-color: white;border: 3px black;&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--    指标下钻--&gt;</span><br><span class="line">  &lt;div id=&quot;screenshot&quot; style=&quot;width:100%;height:90%&quot;&gt;</span><br><span class="line">    &lt;div id=&quot;tree-container&quot; style=&quot;width:100%;height:95%;&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import * as d3 from &#x27;d3&#x27;;</span><br><span class="line">import $ from &#x27;jquery&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">  data()&#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      treeData:&#123;</span><br><span class="line">        name: &#x27;收入&#x27;,</span><br><span class="line">        value:100,</span><br><span class="line">        analysisContent:&quot;demo&quot;,</span><br><span class="line">        children: [</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;电费收入&#x27;,</span><br><span class="line">            value: 10,</span><br><span class="line">            analysisContent:&quot;demo&quot;,</span><br><span class="line">            children: []</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;供热收入&#x27;,</span><br><span class="line">            value: 8,</span><br><span class="line">            analysisContent:&quot;demo&quot;,</span><br><span class="line">            children: []</span><br><span class="line">          &#125;</span><br><span class="line">          ,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;副产品收入&#x27;,</span><br><span class="line">            value: 8,</span><br><span class="line">            analysisContent:&quot;demo&quot;,</span><br><span class="line">            children: []</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            name: &#x27;其他收入&#x27;,</span><br><span class="line">            value: 8,</span><br><span class="line">            analysisContent:&quot;demo&quot;,</span><br><span class="line">            children: []</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      //视图大小</span><br><span class="line">      viewerWidth:null,</span><br><span class="line">      viewerHeight:null,</span><br><span class="line">      minHeight:null,</span><br><span class="line">      //层数 判断是否多层，默认显示2层</span><br><span class="line">      depths:[],</span><br><span class="line">      //对角线投影，供稍后的节点路径使用</span><br><span class="line">      diagonal:null,</span><br><span class="line">      //树布局</span><br><span class="line">      tree:null,</span><br><span class="line">      //总节点数</span><br><span class="line">      totalNodes:null,</span><br><span class="line">      //文字最大长度</span><br><span class="line">      maxLabelLength:null,</span><br><span class="line">      zoomListener:null,</span><br><span class="line">      //dragListener  dragstart</span><br><span class="line">      root:null,</span><br><span class="line">      dragStarted:null,</span><br><span class="line">      nodes:null,</span><br><span class="line">      //dragListener  drag</span><br><span class="line">      panTimer:null,</span><br><span class="line">      //initiateDrag  用于拖放的变量</span><br><span class="line">      draggingNode:null,</span><br><span class="line">      selectedNode:null,</span><br><span class="line">      // panning variables  平移变量</span><br><span class="line">      panSpeed: 200,</span><br><span class="line">      panBoundary: 20, // 拖动时，距离边缘 20px 以内将平移。</span><br><span class="line">      // Misc. variables 其他变量</span><br><span class="line">      i:0,</span><br><span class="line">      domNode:null,</span><br><span class="line"></span><br><span class="line">      //centerNode</span><br><span class="line">      duration:750,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    this.drawTree();</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    drawTree() &#123;</span><br><span class="line">      //show D3 tree</span><br><span class="line">      this.depths = this.treeDepths(this.treeData);</span><br><span class="line">      console.log(this.depths)</span><br><span class="line">      //建立树布局</span><br><span class="line">      this.minHeight = 500;</span><br><span class="line">      this.viewerWidth = $(&quot;#screenshot&quot;).width();</span><br><span class="line">      this.viewerHeight = $(&quot;#screenshot&quot;).height();</span><br><span class="line">      console.log(this.viewerHeight)</span><br><span class="line">      if (this.viewerHeight &lt; this.minHeight)</span><br><span class="line">        this.viewerHeight = this.minHeight</span><br><span class="line">      this.viewerHeight=500</span><br><span class="line"></span><br><span class="line">      this.tree = d3.layout.tree()</span><br><span class="line">          .size([this.viewerHeight, this.viewerWidth]);</span><br><span class="line">      //定义一个d3对角线投影，供稍后的节点路径使用</span><br><span class="line">      this.diagonal = d3.svg.diagonal()</span><br><span class="line">          .projection(d =&gt; &#123;</span><br><span class="line">            return [d.y, d.x];</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">      //call visit to maxLabelLength</span><br><span class="line">      this.visit(this.treeData, (d) =&gt; &#123;</span><br><span class="line">        this.totalNodes++;</span><br><span class="line">        if (d.name) &#123;</span><br><span class="line">          this.maxLabelLength = Math.max(d.name.length, this.maxLabelLength);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          this.maxLabelLength = Math.max(0, this.maxLabelLength);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, (d) =&gt; &#123;</span><br><span class="line">        return d.children &amp;&amp; d.children.length &gt; 0 ? d.children : null;</span><br><span class="line">      &#125;)</span><br><span class="line">      console.log(&quot;总节点&quot;,this.totalNodes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      //排序树最初是为了防止json没有按排序顺序排列</span><br><span class="line">      this.sortTree()</span><br><span class="line">      //定义 zoomListener，该 zoomListener 在 scaleExtents 中约束的“zoom”事件上调用缩放</span><br><span class="line">      this.zoomListener = d3.behavior.zoom().scaleExtent([0.1, 3]).on(&quot;zoom&quot;, () =&gt; &#123;</span><br><span class="line">        this.zoom()</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      //创建视图</span><br><span class="line">      const baseSvg = d3.select(&quot;#tree-container&quot;)</span><br><span class="line">          .append(&#x27;svg&#x27;)</span><br><span class="line">          .attr(&#x27;width&#x27;, this.viewerWidth)</span><br><span class="line">          .attr(&#x27;height&#x27;, this.viewerHeight)</span><br><span class="line">          .attr(&quot;class&quot;,&quot;overlay&quot;)</span><br><span class="line">          .append(&quot;g&quot;)</span><br><span class="line">          .call(this.zoomListener)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      let dragListener = d3.behavior.drag()</span><br><span class="line">          .on(&quot;dragstart&quot;, (d) =&gt; &#123;</span><br><span class="line">            if (d === this.root) &#123;</span><br><span class="line">              return;</span><br><span class="line">            &#125;</span><br><span class="line">            this.dragStarted = true;</span><br><span class="line">            this.nodes = this.tree.nodes(d);</span><br><span class="line">            d3.event.sourceEvent.stopPropagation();</span><br><span class="line">          &#125;).on(&quot;drag&quot;, (d) =&gt; &#123;</span><br><span class="line">            if (d === this.root) &#123;</span><br><span class="line">              return;</span><br><span class="line">            &#125;</span><br><span class="line">            if (this.dragStarted) &#123;</span><br><span class="line">              let domNode = this;</span><br><span class="line">              this.initiateDrag(d, domNode);</span><br><span class="line">            &#125;</span><br><span class="line">            //获取mouseEvent相对于SVG容器的同弦以允许摇摄</span><br><span class="line">            let relCoords = d3.mouse($(&#x27;svg&#x27;).get(0));</span><br><span class="line">            if (relCoords[0] &lt; this.panBoundary)&#123;</span><br><span class="line">              this.panTimer = true;</span><br><span class="line">              this.pan(this, &#x27;left&#x27;);</span><br><span class="line">            &#125;else if (relCoords[0] &gt; ($(&#x27;svg&#x27;).width() - this.panBoundary)) &#123;</span><br><span class="line">              this.panTimer = true;</span><br><span class="line">              this.pan(this, &#x27;right&#x27;);</span><br><span class="line">            &#125;else if (relCoords[1] &lt; this.panBoundary) &#123;</span><br><span class="line">              this.panTimer = true;</span><br><span class="line">              this.pan(this, &#x27;up&#x27;);</span><br><span class="line">            &#125;else if (relCoords[1] &gt; ($(&#x27;svg&#x27;).height() - this.panBoundary)) &#123;</span><br><span class="line">              this.panTimer = true;</span><br><span class="line">              this.pan(this, &#x27;down&#x27;);</span><br><span class="line">            &#125;else &#123;</span><br><span class="line">              try &#123;</span><br><span class="line">                clearTimeout(this.panTimer);</span><br><span class="line">              &#125; catch (e) &#123;</span><br><span class="line"></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            d.x0 += d3.event.dy;</span><br><span class="line">            d.y0 += d3.event.dx;</span><br><span class="line">            var node = d3.select(this);</span><br><span class="line">            node.attr(&quot;transform&quot;, &quot;translate(&quot; + d.y0 + &quot;,&quot; + d.x0 + &quot;)&quot;);</span><br><span class="line">            //更新临时连接器</span><br><span class="line">            this.updateTempConnector();</span><br><span class="line">          &#125;).on(&quot;dragend&quot;, (d) =&gt; &#123;</span><br><span class="line">            if (d === this.root) &#123;return;&#125;</span><br><span class="line">            this.domNode = this;</span><br><span class="line">            if (this.selectedNode)&#123;</span><br><span class="line">              var index = this.draggingNode.parent.children.indexOf(this.draggingNode);</span><br><span class="line">              if (index &gt; -1 )&#123;</span><br><span class="line">                this.draggingNode.parent.children.splice(index, 1);</span><br><span class="line">              &#125;</span><br><span class="line">              if (typeof this.selectedNode.children !== &quot;undefined&quot; || typeof this.selectedNode._children !== &#x27;undefined&#x27;)&#123;</span><br><span class="line">                if (typeof this.selectedNode._children !== &quot;undefined&quot;) &#123;</span><br><span class="line">                  this.selectedNode.children.push(this.draggingNode)</span><br><span class="line">                &#125;else &#123;</span><br><span class="line">                  this.selectedNode._children.push(this.draggingNode)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;else &#123;</span><br><span class="line">                this.selectedNode.children = []</span><br><span class="line">                this.selectedNode.children.push(this.draggingNode)</span><br><span class="line">              &#125;</span><br><span class="line">              //确保要添加到的节点已展开，以便用户可以看到添加的节点已正确移动</span><br><span class="line">              this.expand(this.selectedNode);</span><br><span class="line">              this.sortTree();</span><br><span class="line">              this.endDrag();</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">              this.endDrag();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">      //附加一个包含所有节点的组，缩放侦听器可以对其进行操作。</span><br><span class="line">      this.svgGroup = baseSvg.append(&quot;g&quot;);</span><br><span class="line">      //移除双击</span><br><span class="line">      d3.select(&quot;svg&quot;).on(&quot;dblclick.zoom&quot;, null);</span><br><span class="line">      this.root = this.treeData;</span><br><span class="line">      this.root.x0 = this.viewerHeight/2;</span><br><span class="line">      this.root.y0 = 0;</span><br><span class="line">      //最初布局树并以根节点为中心。</span><br><span class="line">      //添加提示框 div</span><br><span class="line">      this.tooltip = d3.select(&quot;#tree-container&quot;).append(&quot;div&quot;)</span><br><span class="line">          .attr(&quot;class&quot;, &quot;tooltip&quot;)</span><br><span class="line">          .style(&quot;opacity&quot;, &quot;1.0&quot;)</span><br><span class="line">          .style(&quot;display&quot;,&quot;none&quot;);</span><br><span class="line"></span><br><span class="line">      this.root.children.forEach(this.collapse);</span><br><span class="line">      this.update(this.root);</span><br><span class="line">      this.centerNode(this.root);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    //判断是否多层</span><br><span class="line">    treeDepths(g) &#123;</span><br><span class="line">      var depths = [];</span><br><span class="line">      if (g.children)</span><br><span class="line">        g.children.forEach((v) =&gt; &#123;</span><br><span class="line">          this.dfs(v, 1, depths);</span><br><span class="line">        &#125;);</span><br><span class="line">      return depths;</span><br><span class="line">    &#125;,</span><br><span class="line">    //嵌套循环</span><br><span class="line">    dfs(v, depth, depths) &#123;</span><br><span class="line">      var children = v.children;</span><br><span class="line">      if (children &amp;&amp; children.length &gt; 0) &#123;</span><br><span class="line">        children.forEach((child) =&gt; &#123;</span><br><span class="line">          this.dfs(child, depth + 1, depths);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        depths.push(v);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    //递归 通过遍历所有节点  执行某些设置</span><br><span class="line">    visit(parent, visitFn, childrenFn) &#123;</span><br><span class="line">      if (!parent) return;</span><br><span class="line">      visitFn(parent);</span><br><span class="line">      var children = childrenFn(parent);</span><br><span class="line">      if (children) &#123;</span><br><span class="line">        var count = children.length;</span><br><span class="line">        for (var i = 0; i &lt; count; i++) &#123;</span><br><span class="line">          this.visit(children[i], visitFn, childrenFn);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    //排序</span><br><span class="line">    sortTree() &#123;</span><br><span class="line">      console.log(&quot;==排序开始==&quot;)</span><br><span class="line">      this.tree.sort((a, b) =&gt; &#123;</span><br><span class="line">        return b.name ? b.name.toLowerCase() : b.name &lt; a.name ? a.name.toLowerCase() : a.name ? 1 : -1;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    zoom() &#123;</span><br><span class="line">      this.svgGroup.attr(&quot;transform&quot;, &quot;translate(&quot; + d3.event.translate + &quot;)scale(&quot; + d3.event.scale + &quot;)&quot;);</span><br><span class="line">    &#125;,</span><br><span class="line">    //拖拽开始时对节点进行一系列操作，以确保拖拽过程中节点的正确显示和相关连线的调整。</span><br><span class="line">    initiateDrag(d, domNode) &#123;</span><br><span class="line">      /*</span><br><span class="line">      将当前被拖拽的节点保存在this.draggingNode属性中，</span><br><span class="line">      以便在拖拽过程中能够对其进行操作</span><br><span class="line">       */</span><br><span class="line">      this.draggingNode = d;</span><br><span class="line">      /*</span><br><span class="line">      1=</span><br><span class="line">      为了将被拖拽节点的.ghostCircle元素的</span><br><span class="line">      pointer-events属性设置为none，</span><br><span class="line">      以避免拖拽节点时干扰到其他元素</span><br><span class="line">      2=</span><br><span class="line">      为了将所有.ghostCircle元素的类设置为ghostCircle show，</span><br><span class="line">      这可能是用于显示拖拽节点周围的虚拟元素</span><br><span class="line">      3=为了为被拖拽的节点设置类名，可能是用于在拖拽过程中应用特定的样式</span><br><span class="line">       */</span><br><span class="line">      d3.select(domNode).select(&#x27;.ghostCircle&#x27;).attr(&#x27;pointer-events&#x27;, &#x27;none&#x27;);</span><br><span class="line">      d3.selectAll(&#x27;.ghostCircle&#x27;).attr(&#x27;class&#x27;, &#x27;ghostCircle show&#x27;);</span><br><span class="line">      d3.select(domNode).attr(&#x27;class&#x27;, &#x27;node activeDrag&#x27;);</span><br><span class="line"></span><br><span class="line">      /*</span><br><span class="line">      重新排序所有节点，将被拖拽的节点置于最前面，</span><br><span class="line">      以确保它能够在拖拽过程中正确显示在其他节点之上</span><br><span class="line">      选择父项并对路径的</span><br><span class="line">      a 不是悬停元素，将“a”发送到后面</span><br><span class="line">      a 是悬停元素，将“a”放在前面</span><br><span class="line">       */</span><br><span class="line">      this.svgGroup.selectAll(&quot;g.node&quot;).sort((a, b) =&gt; &#123; // select the parent and sort the path&#x27;s</span><br><span class="line">        if (a.id !== this.draggingNode.id) return 1; // a is not the hovered element, send &quot;a&quot; to the back</span><br><span class="line">        else return -1; // a is the hovered element, bring &quot;a&quot; to the front</span><br><span class="line">      &#125;);</span><br><span class="line">      // 如果节点有子节点，请删除链接和节点</span><br><span class="line">      if (this.nodes.length &gt; 1) &#123;</span><br><span class="line">        // remove link paths 删除链接路径</span><br><span class="line">        let links = this.tree.links(this.nodes);</span><br><span class="line">        let nodePaths = this.svgGroup.selectAll(&quot;path.link&quot;)</span><br><span class="line">            .data(links, (d) =&gt; &#123;</span><br><span class="line">              return d.target.id;</span><br><span class="line">            &#125;).remove();</span><br><span class="line">        // remove child nodes 删除子节点</span><br><span class="line">        let nodesExit = this.svgGroup.selectAll(&quot;g.node&quot;)</span><br><span class="line">            .data(this.nodes, (d) =&gt; &#123;</span><br><span class="line">              return d.id;</span><br><span class="line">            &#125;).filter((d, i) =&gt; &#123;</span><br><span class="line">              if (d.id === this.draggingNode.id) &#123;</span><br><span class="line">                return false;</span><br><span class="line">              &#125;</span><br><span class="line">              return true;</span><br><span class="line">            &#125;).remove();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // remove parent link</span><br><span class="line">      let parentLink = this.tree.links(this.tree.nodes(this.draggingNode.parent));</span><br><span class="line">      this.svgGroup.selectAll(&#x27;path.link&#x27;).filter((d, i) =&gt; &#123;</span><br><span class="line">        if (d.target.id === this.draggingNode.id) &#123;</span><br><span class="line">          return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">      &#125;).remove();</span><br><span class="line"></span><br><span class="line">      this.dragStarted = null;</span><br><span class="line">    &#125;,</span><br><span class="line">    pan(domNode, direction)&#123;</span><br><span class="line">      let speed = this.panSpeed,translateX,translateY;</span><br><span class="line">      if (this.panTimer)&#123;</span><br><span class="line">        clearTimeout(this.panTimer);</span><br><span class="line">        let translateCoords = d3.transform(this.svgGroup.attr(&quot;transform&quot;));</span><br><span class="line">        if (direction === &#x27;left&#x27; || direction === &#x27;right&#x27;) &#123;</span><br><span class="line">          translateX = direction === &#x27;left&#x27; ? translateCoords.translate[0] + speed : translateCoords.translate[0] - speed;</span><br><span class="line">          translateY = translateCoords.translate[1];</span><br><span class="line">        &#125;</span><br><span class="line">        else if (direction === &#x27;up&#x27; || direction === &#x27;down&#x27;) &#123;</span><br><span class="line">          translateX = translateCoords.translate[0];</span><br><span class="line">          translateY = direction === &#x27;up&#x27; ? translateCoords.translate[1] + speed : translateCoords.translate[1] - speed;</span><br><span class="line">        &#125;</span><br><span class="line">        let scaleX = translateCoords.scale[0];</span><br><span class="line">        let scaleY = translateCoords.scale[1];</span><br><span class="line">        let scale = this.zoomListener.scale();</span><br><span class="line">        this.svgGroup.transition().attr(&quot;transform&quot;, &quot;translate(&quot; + translateX + &quot;,&quot; + translateY + &quot;)scale(&quot; + scale + &quot;)&quot;);</span><br><span class="line">        d3.select(domNode).select(&#x27;g.node&#x27;).attr(&quot;transform&quot;, &quot;translate(&quot; + translateX + &quot;,&quot; + translateY + &quot;)&quot;);</span><br><span class="line">        this.zoomListener.scale(this.zoomListener.scale());</span><br><span class="line">        this.zoomListener.translate([translateX, translateY]);</span><br><span class="line">        this.panTimer = setTimeout(()=&gt;&#123;</span><br><span class="line">          this.pan(domNode, direction);</span><br><span class="line">        &#125;,50)</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    //to update the temporary connector indicating dragging affiliation</span><br><span class="line">    //更新指示拖动隶属关系的临时连接器</span><br><span class="line">    updateTempConnector() &#123;</span><br><span class="line">      var data = [];</span><br><span class="line">      if (this.draggingNode !== null &amp;&amp; this.selectedNode !== null) &#123;</span><br><span class="line">        // have to flip the source coordinates since we did this for the existing connectors on the original tree</span><br><span class="line">        data = [&#123;</span><br><span class="line">          source: &#123;</span><br><span class="line">            x: this.selectedNode.y0,</span><br><span class="line">            y: this.selectedNode.x0</span><br><span class="line">          &#125;,</span><br><span class="line">          target: &#123;</span><br><span class="line">            x: this.draggingNode.y0,</span><br><span class="line">            y: this.draggingNode.x0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">      &#125;</span><br><span class="line">      let link = this.svgGroup.selectAll(&quot;.templink&quot;).data(data);</span><br><span class="line"></span><br><span class="line">      link.enter().append(&quot;path&quot;)</span><br><span class="line">          .attr(&quot;class&quot;, &quot;templink&quot;)</span><br><span class="line">          .attr(&quot;d&quot;, d3.svg.diagonal())</span><br><span class="line">          .attr(&#x27;pointer-events&#x27;, &#x27;none&#x27;);</span><br><span class="line"></span><br><span class="line">      link.attr(&quot;d&quot;, d3.svg.diagonal());</span><br><span class="line"></span><br><span class="line">      link.exit().remove();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    //展开节点</span><br><span class="line">    expand(d)&#123;</span><br><span class="line">      if (d._children)&#123;</span><br><span class="line">        d.children = d._children;</span><br><span class="line">        d.children.forEach(this.expand)</span><br><span class="line">        d._children = null</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //在拖拽操作结束后，重置节点和虚拟节点的样式和属性，以确保它们恢复到正常状态并且不再响应鼠标事件。</span><br><span class="line">    endDrag()&#123;</span><br><span class="line">      this.selectedNode = null;</span><br><span class="line">      d3.selectAll(&#x27;.ghostCircle&#x27;).attr(&#x27;class&#x27;,&#x27;ghostCircle&#x27;);</span><br><span class="line">      d3.select(this.domNode).attr(&#x27;class&#x27;, &#x27;node&#x27;);</span><br><span class="line">      //禁用这些元素的鼠标事件，使其在拖拽过程中不再响应鼠标交互</span><br><span class="line">      d3.select(this.domNode).select(&#x27;.ghostCircle&#x27;).attr(&#x27;pointer-events&#x27;, &#x27;none&#x27;);</span><br><span class="line">      this.updateTempConnector()</span><br><span class="line">      if (this.draggingNode !=null )&#123;</span><br><span class="line">        this.update(this.root)</span><br><span class="line">        this.centerNode(this.draggingNode)</span><br><span class="line">        this.draggingNode = null;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    //节点更新   重点</span><br><span class="line">    update(source)&#123;</span><br><span class="line">      var width = 130,</span><br><span class="line">          height = 70;</span><br><span class="line">      //计算新 树图的布局</span><br><span class="line">      this.nodes = this.tree.nodes(this.root).reverse();</span><br><span class="line">      let links = this.tree.links(this.nodes)</span><br><span class="line">      //设置y坐标点  每层占  200px；</span><br><span class="line">      this.nodes.forEach(d=&gt;&#123;</span><br><span class="line">        d.y=d.depth * 200</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      //每个node对应一个group</span><br><span class="line">      //data()：绑定一个数组到选择集上，数组的各项值分别与选择集的各元素绑定</span><br><span class="line">      let node = this.svgGroup.selectAll(&quot;g.node&quot;)</span><br><span class="line">          .data(this.nodes, (d) =&gt; &#123;</span><br><span class="line">            return d.id || (d.id = ++ this.i)</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">      //新增节点数据集，设置位置</span><br><span class="line">      //在 svg 中添加一个g，g是 svg 中的一个属性，是 group 的意思，</span><br><span class="line">      // 它表示一组什么东西，如一组 lines ， rects ，circles</span><br><span class="line">      // 其实坐标轴就是由这些东西构成的。</span><br><span class="line">      let nodeEnter = node.enter().append(&quot;g&quot;)</span><br><span class="line">          .attr(&quot;class&quot;, &quot;node&quot;) //attr设置html属性，style设置css属性</span><br><span class="line">          .attr(&quot;transform&quot;, (d) =&gt; &#123;</span><br><span class="line">            return &quot;translate(&quot; + source.y0 + &quot;,&quot; + source.x0 + &quot;)&quot;;</span><br><span class="line">          &#125;).on(&quot;dblclick&quot;, (d) =&gt; &#123; this.click(d) &#125;);</span><br><span class="line">      //添加连接点---此处设置的是圆圈过渡时候的效果（颜色）</span><br><span class="line">      nodeEnter.append(&quot;rect&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, -65)</span><br><span class="line">          .attr(&quot;y&quot;,-35)</span><br><span class="line">          .attr(&quot;width&quot;, width)</span><br><span class="line">          .attr(&quot;height&quot;, height)</span><br><span class="line">          .attr(&quot;rx&quot;, 10)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;#FFF&quot;); //d 代表数据，也就是与某元素绑定的数据。</span><br><span class="line"></span><br><span class="line">      //指标名称</span><br><span class="line">      nodeEnter.append(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, 0)</span><br><span class="line">          .attr(&quot;dy&quot;, -25)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .text((d) =&gt; &#123;</span><br><span class="line">            return d.name;</span><br><span class="line">          &#125;)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;gray&quot;)</span><br><span class="line">          .style(&quot;fill-opacity&quot;, 1)</span><br><span class="line">          .style(&quot;font-size&quot;, &quot;10px&quot;);</span><br><span class="line"></span><br><span class="line">      //指标值</span><br><span class="line">      nodeEnter.append(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, (d) =&gt; &#123;</span><br><span class="line">            return d.children || d._children ? -15 : -15;</span><br><span class="line">          &#125;)</span><br><span class="line">          .attr(&quot;dy&quot;, -5)</span><br><span class="line">          // .attr(&quot;text-anchor&quot;, (d) &#123; return d.children || d._children ? &quot;end&quot; : &quot;start&quot;; &#125;)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .text((d) =&gt; &#123;</span><br><span class="line">            return d.value.toLocaleString();</span><br><span class="line">          &#125;)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;blue&quot;)</span><br><span class="line">          .style(&quot;font-size&quot;, &quot;18px&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      //指标单位</span><br><span class="line">      nodeEnter.append(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, (d) =&gt; &#123;</span><br><span class="line">            return d.children || d._children ? d.value != null ? d.value.toString().length * 6 - 4 : 10 : d.value != null ? d.value.toString().length * 6 - 4 : 10;</span><br><span class="line">          &#125;)</span><br><span class="line">          .attr(&quot;dy&quot;, -5)</span><br><span class="line">          // .attr(&quot;text-anchor&quot;, (d) &#123; return d.children || d._children ? &quot;end&quot; : &quot;start&quot;; &#125;)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .text(&quot;万元&quot;)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;gray&quot;)</span><br><span class="line">          .style(&quot;font-size&quot;, &quot;10px&quot;)</span><br><span class="line"></span><br><span class="line">      nodeEnter.append(&quot;line&quot;)</span><br><span class="line">          .attr(&quot;x1&quot;, -width / 2)</span><br><span class="line">          .attr(&quot;y1&quot;, 5)</span><br><span class="line">          .attr(&quot;x2&quot;, width / 2)</span><br><span class="line">          .attr(&quot;y2&quot;, 5)</span><br><span class="line">          .attr(&quot;stroke&quot;,function(d)&#123;</span><br><span class="line">            if(d.value === 0)&#123;</span><br><span class="line">              return &#x27;#6b6b6b&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">            return &#x27;steelblue&#x27;</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">      nodeEnter.append(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, (d) =&gt; &#123;</span><br><span class="line">            return d.children || d._children ? -40 : -40;</span><br><span class="line">          &#125;)</span><br><span class="line">          .attr(&quot;dy&quot;, 15)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .text((d) =&gt; &#123;</span><br><span class="line">            return &quot;同比&quot;</span><br><span class="line">          &#125;)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;gray&quot;)</span><br><span class="line">          .style(&quot;fill-opacity&quot;, 1)</span><br><span class="line">          .style(&quot;font-size&quot;, &quot;10px&quot;);;</span><br><span class="line"></span><br><span class="line">      nodeEnter.append(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, (d) =&gt; &#123;</span><br><span class="line">            return d.children || d._children ? -58 : -58;</span><br><span class="line">          &#125;)</span><br><span class="line">          .attr(&quot;dy&quot;, 30)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .text(&quot;↑&quot;)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;red&quot;)</span><br><span class="line">          .style(&quot;font-size&quot;, &quot;15px&quot;);</span><br><span class="line"></span><br><span class="line">      // 新增标签标识</span><br><span class="line">      nodeEnter.append(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, 50)</span><br><span class="line">          .attr(&quot;dy&quot;, 29)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .text((d) =&gt; &#123;</span><br><span class="line">            // return &quot;📌&quot;;📑🔖🔗🎫✎</span><br><span class="line">            // return d.labelId != null ? &quot;📑&quot; : &quot;&quot;;</span><br><span class="line">            return &quot;📌&quot;;</span><br><span class="line">          &#125;)</span><br><span class="line">          .style(&quot;fill&quot;,&quot;#2f6db3&quot;)</span><br><span class="line">          .style(&quot;font-size&quot;, &quot;12px&quot;);//75px</span><br><span class="line">      //同比值</span><br><span class="line">      nodeEnter.append(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, (d) =&gt; &#123;</span><br><span class="line">            return d.children || d._children ? -40 : -40;</span><br><span class="line">          &#125;)</span><br><span class="line">          .attr(&quot;dy&quot;, 30)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .text((d) =&gt; &#123;</span><br><span class="line">            return d.anValue != null ? Math.abs(d.anValue)+&#x27;%&#x27; : &quot;&quot;;</span><br><span class="line">          &#125;)</span><br><span class="line">          .style(&quot;fill&quot;, (d) =&gt; &#123;</span><br><span class="line">            return &quot;black&quot;;</span><br><span class="line">          &#125;)</span><br><span class="line">          .style(&quot;font-size&quot;, &quot;10px&quot;)</span><br><span class="line">          //-鼠标移入事件</span><br><span class="line">          .on(&quot;mouseover&quot;, (d) =&gt; &#123;</span><br><span class="line">              let xPosition = d3.event.offsetX;</span><br><span class="line">              let yPosition = d3.event.offsetY + 60;</span><br><span class="line">              //添加标签</span><br><span class="line">              this.tooltip.html(d.analysisContent.replace(/\r/g, &quot;&lt;br&gt;&quot;).replace(/\r\n/g, &quot;&lt;br&gt;&quot;))</span><br><span class="line">                  //设置tooltip的位置(left,top 相对于页面的距离)</span><br><span class="line">                  .style(&quot;left&quot;, xPosition + &quot;px&quot;)</span><br><span class="line">                  .style(&quot;top&quot;, yPosition + &quot;px&quot;)</span><br><span class="line">                  .style(&quot;border-radius&quot;, &quot;10px&quot;)</span><br><span class="line">                  .style(&quot;border&quot;, &quot; 1px solid #999&quot;)</span><br><span class="line">                  .style(&quot;padding&quot;, &quot;5px 10px&quot;)</span><br><span class="line">                  .style(&quot;display&quot;, &quot;block&quot;);</span><br><span class="line">          &#125;)</span><br><span class="line">          //--鼠标移出事件</span><br><span class="line">          .on(&quot;mouseout&quot;, (d) =&gt; &#123;</span><br><span class="line">            this.tooltip.style(&quot;display&quot;, &quot;none&quot;);</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">//计划值名称</span><br><span class="line">      nodeEnter.append(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, (d) =&gt; &#123;</span><br><span class="line">            return d.children || d._children ? 10 : 10;</span><br><span class="line">          &#125;)</span><br><span class="line">          .attr(&quot;dy&quot;, 15)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .text((d) =&gt; &#123;</span><br><span class="line">            return &quot;计划值&quot;</span><br><span class="line">          &#125;)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;gray&quot;)</span><br><span class="line">          .style(&quot;fill-opacity&quot;, 1)</span><br><span class="line">          .style(&quot;font-size&quot;, &quot;10px&quot;);</span><br><span class="line"></span><br><span class="line">      //计划值</span><br><span class="line">      nodeEnter.append(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, (d) =&gt; &#123;</span><br><span class="line">            return d.children || d._children ? 10 : 10;</span><br><span class="line">          &#125;)</span><br><span class="line">          .attr(&quot;dy&quot;, 30)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .text((d) =&gt; &#123;</span><br><span class="line">            return d.value;</span><br><span class="line">          &#125;)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;blue&quot;)</span><br><span class="line">          .style(&quot;font-size&quot;, &quot;12px&quot;);</span><br><span class="line">      //展开趋势图</span><br><span class="line">      nodeEnter.append(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, (d) =&gt; &#123;</span><br><span class="line">            return d.children || d._children ? 50 : 50;</span><br><span class="line">          &#125;)</span><br><span class="line">          .attr(&quot;dy&quot;, 15)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .text((d) =&gt; &#123;</span><br><span class="line">            return &quot;...&quot;</span><br><span class="line">          &#125;)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;gray&quot;)</span><br><span class="line">          .style(&quot;fill-opacity&quot;, 1)</span><br><span class="line">          .style(&quot;font-size&quot;, &quot;28px&quot;)</span><br><span class="line">          .on(&quot;click&quot;, (d, i) =&gt; &#123;</span><br><span class="line">            console.log(&quot;触发点击事件&quot;)</span><br><span class="line">            // this.getChartsData()</span><br><span class="line">            // this.dialogVisible.three = true</span><br><span class="line">          &#125;);</span><br><span class="line">      // Transition nodes to their new position.将节点过渡到一个新的位置-----主要是针对节点过渡过程中的过渡效果</span><br><span class="line">      //node就是保留的数据集，为原来数据的图形添加过渡动画。首先是整个组的位置</span><br><span class="line">      //子节点全出来了</span><br><span class="line">      var nodeUpdate = node.transition() //开始一个动画过度</span><br><span class="line">          .duration(this.duration) //过渡延迟时间 此处主要设置的是圆圈节点随斜线的过渡延迟</span><br><span class="line">          .attr(&quot;transform&quot;, (d) =&gt; &#123;</span><br><span class="line">            return &quot;translate(&quot; + d.y + &quot;,&quot; + d.x + &quot;)&quot;;</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">      nodeUpdate.select(&quot;rect&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, -65)</span><br><span class="line">          .attr(&quot;y&quot;, -35)</span><br><span class="line">          .attr(&quot;width&quot;, width)</span><br><span class="line">          .attr(&quot;height&quot;, height)</span><br><span class="line">          .attr(&quot;rx&quot;, 10)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;#FFF&quot;)</span><br><span class="line">          .style(&quot;stroke&quot;,function(d)&#123;</span><br><span class="line">            if(d.value === 0)&#123;</span><br><span class="line">              return &#x27;#6b6b6b&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">            return &#x27;steelblue&#x27;</span><br><span class="line">          &#125;)</span><br><span class="line">          .style(&quot;stroke-width&quot;, &quot;1.5px&quot;);</span><br><span class="line"></span><br><span class="line">      nodeUpdate.select(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .style(&quot;fill-opacity&quot;, 1);</span><br><span class="line"></span><br><span class="line">      // Transition exiting nodes to the parent&#x27;s new position.过渡现有的节点到父母的新位置。</span><br><span class="line">      //最后处理消失的数据，添加消失动画</span><br><span class="line">      var nodeExit = node.exit().transition()</span><br><span class="line">          .duration(this.duration)</span><br><span class="line">          .attr(&quot;transform&quot;, (d) =&gt; &#123;</span><br><span class="line">            return &quot;translate(&quot; + source.y + &quot;,&quot; + source.x + &quot;)&quot;;</span><br><span class="line">          &#125;)</span><br><span class="line">          .remove();</span><br><span class="line"></span><br><span class="line">      nodeExit.select(&quot;rect&quot;)</span><br><span class="line">          .attr(&quot;x&quot;, -65)</span><br><span class="line">          .attr(&quot;y&quot;, -35)</span><br><span class="line">          .attr(&quot;width&quot;, width)</span><br><span class="line">          .attr(&quot;height&quot;, height)</span><br><span class="line">          .attr(&quot;rx&quot;, 10)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;#FFF&quot;);</span><br><span class="line"></span><br><span class="line">      nodeExit.select(&quot;text&quot;)</span><br><span class="line">          .attr(&quot;text-anchor&quot;, &quot;middle&quot;)</span><br><span class="line">          .style(&quot;fill-opacity&quot;, 1e-6);</span><br><span class="line"></span><br><span class="line">      // Update the links…线操作相关</span><br><span class="line">      //再处理连线集合</span><br><span class="line">      let link = this.svgGroup.selectAll(&quot;path.link&quot;)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;none&quot;)</span><br><span class="line">          .style(&quot;stroke&quot;, &quot;steelblue&quot;)</span><br><span class="line">          .style(&quot;stroke-width&quot;, &quot;1.5px&quot;)</span><br><span class="line">          .data(links, (d) =&gt; &#123;</span><br><span class="line">            return d.target.id;</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">      // Enter any new links at the parent&#x27;s previous position.</span><br><span class="line">      //添加新的连线</span><br><span class="line"></span><br><span class="line">      link.enter().insert(&quot;path&quot;, &quot;g&quot;)</span><br><span class="line">          .style(&quot;fill&quot;, &quot;none&quot;)</span><br><span class="line">          .style(&quot;stroke&quot;, &quot;steelblue&quot;)</span><br><span class="line">          .style(&quot;stroke-width&quot;, &quot;1.5px&quot;)</span><br><span class="line">          .attr(&quot;class&quot;, &quot;link&quot;)</span><br><span class="line">          .attr(&quot;d&quot;, (d) =&gt; &#123;</span><br><span class="line">            var o = &#123;</span><br><span class="line">              x: source.x0,</span><br><span class="line">              y: source.y0</span><br><span class="line">            &#125;;</span><br><span class="line">            return this.diagonal(&#123;</span><br><span class="line">              source: o,</span><br><span class="line">              target: o</span><br><span class="line">            &#125;); //diagonal - 生成一个二维贝塞尔连接器, 用于节点连接图.</span><br><span class="line">          &#125;)</span><br><span class="line">          .attr(&#x27;marker-end&#x27;, &#x27;url(#arrow)&#x27;);</span><br><span class="line"></span><br><span class="line">      // Transition links to their new position.将斜线过渡到新的位置</span><br><span class="line">      //保留的连线添加过渡动画</span><br><span class="line">      link.transition()</span><br><span class="line">          .duration(this.duration)</span><br><span class="line">          .attr(&quot;d&quot;, this.diagonal);</span><br><span class="line"></span><br><span class="line">      // Transition exiting nodes to the parent&#x27;s new position.过渡现有的斜线到父母的新位置。</span><br><span class="line">      //消失的连线添加过渡动画</span><br><span class="line">      link.exit().transition()</span><br><span class="line">          .duration(this.duration)</span><br><span class="line">          .attr(&quot;d&quot;, (d) =&gt; &#123;</span><br><span class="line">            var o = &#123;</span><br><span class="line">              x: source.x,</span><br><span class="line">              y: source.y</span><br><span class="line">            &#125;;</span><br><span class="line">            return this.diagonal(&#123;</span><br><span class="line">              source: o,</span><br><span class="line">              target: o</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;)</span><br><span class="line">          .remove();</span><br><span class="line">      // Stash the old positions for transition.将旧的斜线过渡效果隐藏</span><br><span class="line">      this.nodes.forEach((d) =&gt; &#123;</span><br><span class="line">        d.x0 = d.x;</span><br><span class="line">        d.y0 = d.y;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    //收缩节点</span><br><span class="line">    collapse(d)&#123;</span><br><span class="line">      if (d.children)&#123;</span><br><span class="line">        d._children=d.children;</span><br><span class="line">        d.children=null</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    //当点击/删除时，中心节点，这样节点在折叠/移动时不会丢失大量的子节点。</span><br><span class="line">    centerNode(source)&#123;</span><br><span class="line">      //scale()方法用于返回当前的缩放比例值  缩放比例值</span><br><span class="line">      let scale = this.zoomListener.scale();</span><br><span class="line">      let x = -source.y0;</span><br><span class="line">      let y = -source.x0;</span><br><span class="line">      x = x* scale +100;</span><br><span class="line">      y = y* scale +this.viewerHeight /2;</span><br><span class="line">      d3.select(&#x27;g&#x27;).transition()</span><br><span class="line">          .duration(this.duration)</span><br><span class="line">          .attr(&quot;transform&quot;, &quot;translate(&quot; + x + &quot;,&quot; + y + &quot;)scale(&quot; + scale + &quot;)&quot;);</span><br><span class="line">      this.zoomListener.scale(scale);</span><br><span class="line">      this.zoomListener.translate([x, y]);</span><br><span class="line">    &#125;,</span><br><span class="line">    //点击事件</span><br><span class="line">    click(d)&#123;</span><br><span class="line">      if (d.children)&#123;</span><br><span class="line">        d._children=d.children;</span><br><span class="line">        d.children = null</span><br><span class="line">      &#125;else&#123;</span><br><span class="line">        d.children = d._children</span><br><span class="line">        if (d.children === [] || d.children == null)&#123;</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br><span class="line">        d.children.forEach(this.collapse)</span><br><span class="line">        d._children = null;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      let depths = this.treeDepths(this.treeData);</span><br><span class="line">      this.viewerHeight = depths.length * 100;</span><br><span class="line">      if (this.viewerHeight &lt; this.minHeight)</span><br><span class="line">        this.viewerHeight = this.minHeight;</span><br><span class="line">      this.tree = d3.layout.tree()</span><br><span class="line">          .size([this.viewerHeight, this.viewerWidth]);</span><br><span class="line">      this.update(d)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">circle &#123;</span><br><span class="line">  fill: #ccc;</span><br><span class="line">  stroke: #000;</span><br><span class="line">  stroke-width: 1px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">text &#123;</span><br><span class="line">  font-size: 12px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">path.link &#123;</span><br><span class="line">  fill: none;</span><br><span class="line">  stroke: #ccc;</span><br><span class="line">  stroke-width: 1.5px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><div class="tags"><a href="/tags/D3-js/" rel="tag"><i class="ic i-tag"></i> D3.js</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2024-07-27 11:24:35" itemprop="dateModified" datetime="2024-07-27T11:24:35+08:00">2024-07-27</time> </span><span id="2024/07/15/post/vue/D3.js   V3版本/" class="item leancloud_visitors" data-flag-title="D3.js V3版本  学习笔记" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>ZoroJan <i class="ic i-at"><em>@</em></i>CYX</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/2024/07/15/post/vue/D3.js%20%20%20V3%E7%89%88%E6%9C%AC/" title="D3.js V3版本  学习笔记">http://example.com/2024/07/15/post/vue/D3.js V3版本/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/07/05/post/springboot/03-Mybatis-Plus%20@SqlParser%E6%B3%A8%E8%A7%A3/" itemprop="url" rel="prev" data-background-image="&#x2F;assets&#x2F;1.png" title="03-Mybatis-Plus @SqlParser注解"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 后端</span><h3>03-Mybatis-Plus @SqlParser注解</h3></a></div><div class="item right"><a href="/2024/07/16/post/vue/%E4%BF%AE%E6%94%B9avue%E9%BB%98%E8%AE%A4%E7%BB%84%E4%BB%B6%E6%A0%B7%E5%BC%8F/" itemprop="url" rel="next" data-background-image="&#x2F;assets&#x2F;9.png" title="修改avue默认组件样式"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 前端</span><h3>修改avue默认组件样式</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#d3.js-v3%E7%89%88%E6%9C%AC"><span class="toc-number">1.</span> <span class="toc-text">D3.js V3版本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#d3-tree"><span class="toc-number">1.1.</span> <span class="toc-text">D3 Tree</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">安装组件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E6%A1%88%E4%BE%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">直接上一个简单案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8d3-tree-%E5%81%9A%E4%B8%80%E4%B8%AA%E6%8C%87%E6%A0%87%E4%B8%8B%E9%92%BB%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.</span> <span class="toc-text">用D3 tree 做一个指标下钻功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#d3-%E6%96%B9%E6%B3%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.</span> <span class="toc-text">d3 方法介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#append"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">append()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#d3.behavior.drag"><span class="toc-number">1.3.0.1.1.</span> <span class="toc-text">d3.behavior.drag()</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#end-%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">1.4.</span> <span class="toc-text">End 完整代码</span></a></li></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2024/06/09/post/vue/hello-world/" rel="bookmark" title="暂时置顶文章">暂时置顶文章</a></li><li class="active"><a href="/2024/07/15/post/vue/D3.js%20%20%20V3%E7%89%88%E6%9C%AC/" rel="bookmark" title="D3.js V3版本  学习笔记">D3.js V3版本 学习笔记</a></li><li><a href="/2024/07/16/post/vue/%E4%BF%AE%E6%94%B9avue%E9%BB%98%E8%AE%A4%E7%BB%84%E4%BB%B6%E6%A0%B7%E5%BC%8F/" rel="bookmark" title="修改avue默认组件样式">修改avue默认组件样式</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="ZoroJan" data-src="/images/avatar.jpg"><p class="name" itemprop="name">ZoroJan</p><div class="description" itemprop="description">我的个人博客</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">31</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">15</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">25</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0k4Wm9ybzhJ" title="https:&#x2F;&#x2F;github.com&#x2F;I8Zoro8I"><i class="ic i-github"></i></span> <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMTc5NDkxNDQ4P3NwbV9pZF9mcm9tPTMzMy4xMDA3LjAuMA==" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;179491448?spm_id_from&#x3D;333.1007.0.0"><i class="ic i-bilibili"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEzMDk4Mzg3OTU=" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;1309838795"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vNjMzOTY2OTQ3Mg==" title="https:&#x2F;&#x2F;weibo.com&#x2F;6339669472"><i class="ic i-weibo"></i></span> <span class="exturl item email" data-url="bWFpbHRvOm0xNTg2MDg2MDM4NkAxNjMuY29t" title="mailto:m15860860386@163.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-magic"></i>链环</a><ul class="submenu"><li class="item"><a href="/site/" rel="section"><i class="ic i-star"></i>网站</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2024/07/05/post/springboot/03-Mybatis-Plus%20@SqlParser%E6%B3%A8%E8%A7%A3/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/07/16/post/vue/%E4%BF%AE%E6%94%B9avue%E9%BB%98%E8%AE%A4%E7%BB%84%E4%BB%B6%E6%A0%B7%E5%BC%8F/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/vue/" title="分类于 前端">前端</a></div><span><a href="/2024/06/09/post/vue/hello-world/" title="暂时置顶文章">暂时置顶文章</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/biao/" title="分类于 标标备忘录">标标备忘录</a> <i class="ic i-angle-right"></i> <a href="/categories/biao/shor/" title="分类于 Shor算法详解">Shor算法详解</a></div><span><a href="/2024/06/10/post/biao/shor/Shor%20algorithm/" title="Shor算法详解">Shor算法详解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/job/" title="分类于 工作日志">工作日志</a></div><span><a href="/2024/07/01/post/job/06-%E7%8F%A0%E5%95%A4%E5%BC%80%E5%8F%91%E4%BB%BB%E5%8A%A1%E5%B0%8F%E8%AE%B0/" title="06-珠啤开发任务小记">06-珠啤开发任务小记</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Go/" title="分类于 Go">Go</a></div><span><a href="/2024/08/20/post/golang/01-Go%E6%8C%87%E5%8D%97/" title="1-Go指南">1-Go指南</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Go/" title="分类于 Go">Go</a></div><span><a href="/2024/08/22/post/golang/3-Go%E6%8C%87%E5%8D%97-%E6%B3%9B%E5%9E%8B/" title="3-Go指南-泛型">3-Go指南-泛型</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/sql/" title="分类于 数据库">数据库</a></div><span><a href="/2024/07/16/post/sql/02-%E6%97%B6%E9%97%B4%E5%88%A4%E6%96%AD%E6%9F%A5%E8%AF%A2/" title="PostgreSQL中筛选月份和年份查询数据集">PostgreSQL中筛选月份和年份查询数据集</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/windows/" title="分类于 Windows">Windows</a> <i class="ic i-angle-right"></i> <a href="/categories/windows/pid/" title="分类于 进程">进程</a></div><span><a href="/2024/06/13/post/windows/pid/windows%E8%BF%9B%E7%A8%8B/" title="windows进程命令">windows进程命令</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/utils/" title="分类于 实用小工具">实用小工具</a></div><span><a href="/2024/08/15/post/utils/JRebel%20%E4%BD%BF%E7%94%A8debug%E7%BC%96%E8%AF%91%E5%8D%A1%E4%BD%8F%E9%97%AE%E9%A2%98/" title="实用小工具">实用小工具</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/hexo/" title="分类于 博客">博客</a></div><span><a href="/2024/07/04/post/hexo/01-Hexo%E4%B8%AD%E6%94%AF%E6%8C%81Latex%E5%85%AC%E5%BC%8F/" title="Hexo中支持Latex公式">Hexo中支持Latex公式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/vue/" title="分类于 前端">前端</a></div><span><a href="/2024/07/15/post/vue/D3.js%20%20%20V3%E7%89%88%E6%9C%AC/" title="D3.js V3版本  学习笔记">D3.js V3版本 学习笔记</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">ZoroJan @ ZoroJan-个人博客</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">234k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">3:33</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/07/15/post/vue/D3.js   V3版本/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->